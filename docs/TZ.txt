# Техническое задание

**Интрадей-бот для линейных фьючерсов Bybit (USDT-perp)**

---

## 1. Вводная часть и контекст

### 1.1. Назначение системы

Разрабатывается автоматический торговый бот на Python для линейных фьючерсов Bybit (категория **USDT-perpetual**), запускаемый локально на **macOS**.

Бот:

* самостоятельно генерирует сигналы и открывает/закрывает позиции (long/short) по заданным стратегиям;
* использует динамический выбор таймфрейма (TF-профили), пред-трейд фильтры ликвидности и строгий риск-менеджмент;
* работает **без ручного подтверждения** сделок;
* дублирует ключевые события и статистику в **Telegram-бот**.

### 1.2. Цели

Основная цель:
полностью автоматическая торговля линейными фьючерсами Bybit с контролируемыми рисками и расширяемой архитектурой стратегий.

Подцели:

1. Реализовать ядро, способное:

   * собирать данные через API Bybit;
   * рассчитывать рыночные метрики и индикаторы;
   * классифицировать режим рынка и выбирать TF-профиль;
   * генерировать сигналы стратегий и исполнять их в виде ордеров.
2. Реализовать риск-менеджмент:

   * риск на сделку, дневной лимит потерь, ограничение количества позиций, cooldown.
3. Реализовать интеграцию с Telegram:

   * уведомления + минимальное управление торговлей.
4. Обеспечить логирование и сохранение статистики:

   * JSON-логи, CSV с трейдами, JSON-сводки.
5. Обеспечить расширяемость:

   * добавление новых стратегий без переписывания ядра (риск, фильтры, логирование, Telegram).

### 1.3. Целевая аудитория

* Один конкретный пользователь — владелец бота.
  Система не предназначена для публичного распространения.

### 1.4. Критерии готовности (MVP)

Бот считается реализованным, если:

1. Запускается локально на macOS, читает конфиги, подключается к Bybit и Telegram.
2. В режиме **demo** и **live**:

   * получает рыночные данные;
   * рассчитывает все требуемые метрики;
   * определяет режим рынка и TF-профиль;
   * применяет пред-трейд фильтры и риск-ограничения.
3. Реализованы стратегии A–E через единый интерфейс `generate_signals` и сигналы корректно конвертируются в ордера.
4. Риск-менеджмент соблюдает:

   * `per_trade_risk_pct = 0.0035` (0.35%),
   * `max_daily_loss_pct = 0.015` (1.5%),
   * `max_concurrent_positions = 2`,
   * `cooldown_after_loss_min = 20`.
5. Telegram-бот:

   * уведомляет об открытии/закрытии сделок и итогох;
   * обрабатывает команды `/start_bot`, `/stop_bot`, `/status`, `/set_risk`.
6. Пишутся JSON-логи и формируются CSV/JSON-отчёты по сделкам и сессиям.

---

## 2. Область применения и сценарии использования

### 2.1. Основные сценарии

**Сценарий 1. Запуск и включение торговли**

1. Пользователь запускает бота локально.
2. Бот загружает конфиги (торговый и секретов), подключается к Bybit и Telegram.
3. По умолчанию состояние `bot_state = "idle"` (торговля выключена).
4. Пользователь в Telegram отправляет `/start_bot`.
5. `bot_state` переходит в `"trading"`, бот каждые `update_interval_sec` секунд (по умолчанию 15) выполняет цикл:

   * обновление данных,
   * расчёт метрик и режима,
   * генерация сигналов,
   * проверка фильтров и рисков,
   * отправка/обновление ордеров.

**Сценарий 2. Остановка торговли**

1. Во время активной торговли пользователь отправляет `/stop_bot`.
2. Бот:

   * немедленно блокирует новые входы (новые сигналы игнорируются);
   * продолжает сопровождение открытых позиций (SL/TP, трейлинг, time-stop);
   * после закрытия последней позиции отправляет итоговый отчёт по сессии;
   * переводит `bot_state` в `"stopped"`.

**Сценарий 3. Мониторинг**

* Пользователь отправляет `/status`.
* Бот в ответ показывает:

  * режим Bybit (`live` / `demo`);
  * состояние бота (`idle` / `trading` / `stopped`);
  * список активных позиций (символ, side, size, entry_price, SL/TP, текущий PnL);
  * текущие параметры риска (per_trade_risk_pct, дневной PnL относительно лимита).

**Сценарий 4. Корректировка риска**

* Пользователь отправляет `/set_risk 0.004` (0.4%).
* Бот валидирует значение, обновляет `per_trade_risk_pct` в runtime и подтверждает новое значение в Telegram.

**Сценарий 5. Периодические и итоговые отчёты**

* Раз в `stats.interval_min` минут (по умолчанию 60) бот отправляет сводку:

  * PnL за день,
  * число сделок, winrate,
  * PnL по стратегиям,
  * Leakage%, средний slippage.
* После `/stop_bot` и при завершении процесса (если возможно) отправляется итоговый отчёт за сессию.

### 2.2. Ограничения

Бот:

* **не** торгует спотом, инверсными контрактами, опционами;
* **не** принимает ручные торговые ордера от пользователя (только команды управления режимом);
* **не** управляет депозитами/выводами средств;
* **не** предоставляет публичный API/веб-интерфейс в первой версии;
* **не** гарантирует доходность.

“Торговый день” определяется по локальному времени **Europe/Minsk (UTC+3)**, граница дня — 00:00.

---

## 3. Площадки и инструменты

### 3.1. Биржа

* Биржа: **Bybit**.
* Инструменты: линейные фьючерсы **USDT-perpetual**.

### 3.2. Список символов и групп

**Core:**

* BTCUSDT
* ETHUSDT
* SOLUSDT

**Plus:**

* XRPUSDT
* BNBUSDT
* DOGEUSDT
* TONUSDT
* LINKUSDT
* ADAUSDT
* AVAXUSDT

**Rotation (кандидаты для ротации):**

* SUIUSDT
* ARBUSDT
* OPUSDT
* SEIUSDT
* NEARUSDT
* ATOMUSDT

Для каждого символа в торговом конфиге:

* `symbol: str`;
* `group: "core" | "plus" | "rotation"`;
* `enabled: bool` (по умолчанию `true` для core/plus, `false` для rotation);
* `max_leverage: int` (по умолчанию 5);
* при необходимости `max_notional_usdt: float`.

### 3.3. Фильтры по группе (ликвидность)

Перед входом в сделку:

* **Core:**

  * `depth_±1%_usd ≥ 3_000_000`,
  * `spread_bps ≤ 3`.
* **Альты (plus, rotation):**

  * `depth_±1%_usd ≥ 1_000_000`,
  * `spread_bps ≤ 5`.

Если фильтр по группе не пройден — новые входы по символу запрещены.

### 3.4. Режимы аккаунта и API-ключи

Бот поддерживает два режима подключения к Bybit:

* `bybit.mode = "live"` — основной аккаунт (реальные средства);
* `bybit.mode = "demo"` — демо-режим основного аккаунта (не testnet).

В конфиге секретов хранятся **две пары ключей**:

```yaml
bybit:
  live:
    api_key: "YOUR_LIVE_API_KEY"
    api_secret: "YOUR_LIVE_API_SECRET"
  demo:
    api_key: "YOUR_DEMO_API_KEY"
    api_secret: "YOUR_DEMO_API_SECRET"
```

Выбор ключей:

* при `bybit.mode = "live"` используются `bybit.live.*`;
* при `bybit.mode = "demo"` — `bybit.demo.*`.

Переключение режима производится **только** через `bybit.mode` в конфиге торговых параметров + перезапуск бота. Telegram-команды не могут менять режим аккаунта.

---

## 4. Функциональная архитектура

### 4.1. Подсистемы

Основные подсистемы:

* `config` — загрузка, валидация конфигов;
* `data_feed` — получение свечей, стакана, сделок, OI;
* `market_state` — расчёт метрик и подготовка `MarketState`;
* `regime_classifier` — режим рынка (Trend / Range);
* `tf_selector` — выбор TF-профиля (AGGR/BAL/CONS);
* `filters` — пред-трейд фильтры (ликвидность, slippage, latency, объём);
* `strategies` — набор стратегий A–E;
* `risk` — риск-менеджмент и лимиты;
* `execution` — подготовка и отправка ордеров, управление SL/TP;
* `rotation` — скоринг и ротация символов;
* `telemetry/logging` — логи и отчёты;
* `telegram_interface` — Telegram-бот и команды;
* `main` — основной цикл, оркестрация.

### 4.2. MarketState и метрики

#### 4.2.1. Частота и таймфреймы

* Период обновления: `update_interval_sec = 15` (по умолчанию).
* Используемые TF: **1m, 3m, 5m, 15m, 1h**.
* ATR: 5m; ADX: 15m; VWAP: триггерный TF профиля (1m/3m/5m).

#### 4.2.2. Метрики для каждого символа

Из стакана:

* `best_bid_1`, `best_ask_1`;
* `mid_price = (best_ask_1 + best_bid_1) / 2`;
* `spread_bps = (best_ask_1 - best_bid_1) / mid_price * 10_000`.

Глубина:

* `depth_±1%_usd` — сумма `price_i * size_i` по всем уровням (bid+ask) с `price_i ∈ [mid_price * 0.99; mid_price * 1.01]`.

Slippage:

* `slippage_bps = (fill_price - ref_price) / ref_price * side_sign * 10_000`,
  где `ref_price` = `mid_price` в момент сигнала, `side_sign = +1` для long, `-1` для short.
* `avg_slippage_bps` — EMA по последним `N_slip = 20` сделкам по символу.

Объём и поток:

* `volume_5m` — объём сделок за последний 5m-бар.
* `rel_volume_5m = volume_5m / median(volume_5m за последние N_vol = 20 баров)`.
* `delta_flow_1m = buy_volume_1m - sell_volume_1m` за последние 60 секунд (по стороне агрессора).

ATR и волатильность:

* `ATR_14_5m` — ATR(14) по 5m-свечам.
* `atr_q_5m` — квантиль ATR по выборке длиной `N_atr = 288` (24 часа) → значение в [0, 1].

VWAP:

* `VWAP_window` — VWAP по последним `N_vwap = 20` барам триггерного TF.
* `vwap_slope_raw` — наклон линейной регрессии `VWAP_window` (цена/бар).
* `vwap_slope = vwap_slope_raw / VWAP_window_mean` — нормированный наклон.

Пороги:

* `vwap_slope_flat_threshold = 0.0001`;
* `vwap_slope_strong_trend_threshold = 0.0005`.

Open interest:

* `oi_delta_5m = open_interest_now - open_interest_5_min_ago`.

Отклонение от VWAP:

* `price_ref_for_vwap` — close бара при сигнале;
* `distance_to_vwap = |price_ref_for_vwap - VWAP_window_last|`;
* `sigma_vwap` — std(close − VWAP_window) за `N_vwap` баров.

Leakage%:

* `gross_pnl` — PnL до fees и slippage_cost;
* `fees`, `slippage_cost`;
* `Leakage% = (fees + slippage_cost) / gross_pnl` (если `gross_pnl > 0`, иначе — невалидно).

#### 4.2.3. Структура `MarketState` (минимальные поля)

Для каждого символа в текущий момент:

* `symbol: str`
* `mid_price: float`
* `spread_bps: float`
* `depth_pm1_usd: float` (`depth_±1%_usd`)
* `volume_5m: float`
* `rel_volume_5m: float`
* `delta_flow_1m: float`
* `ATR_14_5m: float`
* `atr_q_5m: float`
* `VWAP_window: list[float]` или агрегированные показатели (последнее значение и среднее)
* `vwap_slope: float`
* `oi_delta_5m: float`
* `price_ref_for_vwap: float`
* `distance_to_vwap: float`
* `sigma_vwap: float`
* `avg_slippage_bps: float`
* `latency_ms: float`
* `regime: "Trend" | "Range"`
* `tf_profile: "AGGR" | "BAL" | "CONS"`

### 4.3. Режим рынка: Trend / Range

Используется:

* `ADX_15m` (индекс направленного движения по 15mTF);
* `atr_q_5m`;
* `vwap_slope`.

Пороговые значения:

* **Trend**:

  * `ADX_15m ≥ 20`,
  * `atr_q_5m ≥ 0.6`,
  * `vwap_slope ≥ 0` (для long-контекста).
* **Range**:

  * `ADX_15m < 15` **или**
  * `atr_q_5m ≤ 0.4` **или**
  * `|vwap_slope| ≤ 0.0001`.

Гистерезис:

* смена режима происходит только при подтверждении нового состояния на `hysteresis_bars = 3` подряд барах 15m.

### 4.4. TF-профили (AGGR/BAL/CONS)

Профили:

* **AGGR**:

  * триггерный TF: 1m;
  * фильтры: 5m / 15m.
* **BAL**:

  * триггерный TF: 3m;
  * фильтры: 5m / 15m.
* **CONS**:

  * триггерный TF: 5m;
  * фильтры: 15m / 1h.

Пороговые условия:

Параметры:

* `atr_q_aggr_min = 0.7`;
* `rel_volume_aggr_min = 1.4`;
* `atr_q_cons_max = 0.3`;
* `rel_volume_cons_max = 0.8`;
* `spread_aggr_max_core = 2.5`;
* `spread_aggr_max_alt = 4.0`;
* `depth_aggr_mult = 1.2`;
* `latency_aggr_max_ms = 120`;
* `latency_cons_min_ms = 160`;
* `slippage_cons_factor = 1.2`.

**AGGR (кандидат):**

* `atr_q_5m ≥ 0.7`;
* `rel_volume_5m ≥ 1.4`;
* core: `spread_bps ≤ 2.5`; альты: `spread_bps ≤ 4.0`;
* `depth_±1%_usd ≥ depth_aggr_mult * depth_min_group`
  (3.6M для core, 1.2M для альтов);
* `latency_ms ≤ 120`;
* `avg_slippage_bps ≤ spread_bps`.

**CONS (кандидат), если выполнены ≥2 из:**

* `atr_q_5m ≤ 0.3`;
* `rel_volume_5m ≤ 0.8`;
* `latency_ms ≥ 160` **или** `avg_slippage_bps ≥ 1.2 * spread_bps`.

Если не AGGR и не CONS — профиль BAL.

Гистерезис профилей:

* `hits_up = 3` (AGGR), `hits_down = 2` (CONS);
* `cooldown_bars = 5` (по триггерному TF):

  * после смены профиля повторная смена запрещена 5 баров.

Правило после 22:00 (локальное время Europe/Minsk):

* при первом обновлении после 22:00:

  * AGGR → BAL;
  * BAL → CONS;
  * CONS остаётся CONS.

### 4.5. Пред-трейд фильтры (ликвидность и издержки)

* **Глубина:**

  * core: `depth_±1%_usd ≥ 3_000_000`;
  * альты: `depth_±1%_usd ≥ 1_000_000`.
* **Спред:**

  * core: `spread_bps ≤ 3`;
  * альты: `spread_bps ≤ 5`.
* **Латентность:**

  * `latency_ms_max = 200`; при превышении — новые входы запрещены.
* **Относительный объём:**

  * тренд/пробой: `rel_volume_5m ≥ 1.2`;
  * mean-reversion/VWAP: `rel_volume_5m ≥ 1.0`.
* **Slippage-фильтр:**

  * `slippage_auto_reject_factor = 1.0`;
  * `slippage_window_min = 15` минут;
    если `avg_slippage_bps > spread_bps` непрерывно ≥15 минут, новые входы по символу запрещены.

Если хотя бы один фильтр не пройден — новые входы запрещены (закрытие позиций разрешено).

### 4.6. Интерфейс стратегий и модульность

#### 4.6.1. Структуры

**PositionState (минимум):**

* наличие открытой позиции по символу/стратегии;
* side (`long`/`short`);
* size (контракты/USDT);
* entry_price;
* `initial_sl_price`, `current_sl_price`;
* `trailing_mode`, `trailing_params`.

**Signal:**

* `symbol: str`;
* `side: "long" | "short"`;
* `entry_type: "limit_on_retest" | "market_with_cap"`;
* `strategy_id: str`;
* `target_risk_pct` или `target_notional_usdt`;
* `sl_price: float`;
* `tp_levels: list[float]`;
* `time_stop_bars: int | None`;
* `trailing_mode: str | None`;
* `trailing_params: dict | None`.

#### 4.6.2. Контракт стратегии

Любая стратегия:

* `id: str`;
* `name: str`;
* `generate_signals(market_state, position_state, config) -> list[Signal]`.

Ограничения:

* стратегия **не** обращается к Bybit/файлам/Telegram;
* стратегия только читает вход и возвращает сигналы.

#### 4.6.3. Реестр стратегий

В модуле стратегий:

```text
strategies_registry: dict[str, StrategyClass/Factory]
```

В торговом конфиге:

```yaml
strategies:
  A_trend:
    enabled: true
  B_bb_squeeze:
    enabled: true
  C_range_break:
    enabled: true
  D_vwap_mean_reversion:
    enabled: true
  E_liquidity_sweep:
    enabled: true
```

При `enabled: true` стратегия участвует в основном цикле, логирование и статистика строятся по `strategy_id`.

### 4.7. Стратегии A–E (фиксированные параметры)

(Все параметры можно выносить в конфиг, но дефолты закреплены в ТЗ.)

#### 4.7.1. A: Trend-Continuation (EMA20/50 + ADX + VWAP)

* TF: триггерный TF профиля (1m/3m/5m).
* Условия long:

  * цена в коридоре `EMA20 ± 1 тик` (`ema20_tolerance_ticks = 1`);
  * `EMA20 > EMA50`;
  * `vwap_slope ≥ 0`;
  * `ADX_15m ≥ 20`;
  * `rel_volume_5m ≥ 1.1`;
  * `distance_to_vwap ≤ 2 * sigma_vwap`.
* SL/TP:

  * `SL = entry_price - 1.2 * ATR_14_5m` (для long);
  * `TP1 = entry_price + 1R`;
  * `TP2 = entry_price + 2R`;
  * остаток — по трейлингу (`trailing_mode = "ema_atr"`).

Short — зеркально.

#### 4.7.2. B: BB-Squeeze → Break & Retest (BB20/2, KC20/1.5)

* TF: триггерный.
* Индикаторы:

  * BB(20, 2σ);
  * KC(20, 1.5).
* Параметры: `N_squeeze = 20`, `retest_tolerance_bps = 5`.
* Сжатие: BB внутри KC ≥ 20 баров.
* Пробой:

  * close выше верхней BB (long) или ниже нижней BB (short);
  * `rel_volume_5m ≥ 1.3`;
  * `oi_delta_5m` совпадает по знаку с направлением.
* Вход по ретесту уровня пробоя (±5 bps).
* SL/TP:

  * `SL = 1 * ATR_14_5m` за противоположной BB;
  * `TP1 = 1.5 * ATR_14_5m`;
  * `TP2 = 3 * ATR_14_5m`.

#### 4.7.3. C: Range-Break & Retest (ATR-gate)

* Базовый TF диапазона: 5m.
* Диапазон: high/low последних 12 баров (≈60 мин).
* Условия пробоя:

  * `atr_q_5m ≥ 0.75`;
  * `rel_volume_5m ≥ 1.3`.
* Вход по ретесту high/low (±5 bps).
* SL/TP:

  * SL — возврат внутрь диапазона + половина ширины;
  * TP — высота диапазона, остаток по трейлингу.

#### 4.7.4. D: VWAP Mean-Reversion (±1.5–2σ)

Параметры:

* `k_upper = 1.5`; `k_lower = 1.5`.

Long:

* цена > `VWAP + k_upper * sigma_vwap`;
* замедление `|delta_flow_1m|` (≤ 0.7 × среднее 5 последних минут);
* абсорбция: встречный лимитный объём ≥ 60%;
* блокировка против сильного тренда:
  если `|vwap_slope| > 0.0005`, сигналы отвергаются.

SL/TP:

* SL — за внешней VWAP-бандой + `0.5 * ATR_14_5m`;
* TP1 — возврат к VWAP;
* TP2 — mid-уровень/противоположная банда (см. конфиг).

Short — зеркально.

#### 4.7.5. E: Liquidity-Sweep Reversal (стоп-ханты)

Применяется для:

* BTCUSDT, ETHUSDT.

Параметры:

* `N_sweep = 15` баров триггерного TF;
* `sl_buffer_ticks = 3`.

Условия:

1. Цена обновляет high/low за `N_sweep` баров.
2. Абсорбция: объём в одну сторону ≥ 60%.
3. Разворот `delta_flow_1m` по знаку.
4. `latency_ms ≤ 200`, `avg_slippage_bps ≤ spread_bps`.

SL/TP:

* SL — за экстремум + `sl_buffer_ticks`;
* TP1 — VWAP;
* TP2 — край диапазона.

#### 4.7.6. Частичные закрытия и time-stop

* 50% объёма при 1R;
* 25% при 2R;
* 25% по трейлингу.
* `time_stop_bars = 20` баров триггерного TF:
  если нет прогресса — выход по рынку.

### 4.8. Ротация символов

Параметры:

* `rotation.check_interval_min = 5`;
* `rotation.min_score = 0.55`;
* `rotation.top_n = 5`.

Формула:

```text
score = 0.4 * norm(depth_±1%) +
        0.3 * norm(1 / spread_bps) +
        0.2 * norm(rel_volume_5m) +
        0.1 * norm(oi_delta_5m)
```

* `norm()` — нормировка по скользящему окну (например, 24ч) в [0, 1].

Активный список:

* все core;
* все, у кого `score ≥ 0.55`;
* минимум `top_n` символов, если возможно.

Результат ротации записывается в JSON-лог.

### 4.9. Риск-менеджмент и динамический SL

Параметры:

* `virtual_equity_usdt` (например, 150 USDT);
* `per_trade_risk_pct = 0.0035`;
* `max_daily_loss_pct = 0.015`;
* `max_concurrent_positions = 2`;
* `cooldown_after_loss_min = 20`;
* `max_leverage = 5` (isolated).

Расчёт размера позиции:

* риск в деньгах = `per_trade_risk_pct * virtual_equity_usdt`;
* размер позиции выбирается так, чтобы убыток при SL ≈ риск в деньгах, с учётом max_leverage и max_notional.

Дневной лимит:

* при достижении PnL за день ≤ `-max_daily_loss_pct * virtual_equity_usdt`:

  * закрываются все позиции;
  * новые входы запрещены до 00:00 (Europe/Minsk).

Cooldown:

* после любой убыточной сделки:

  * запрещены новые входы на `cooldown_after_loss_min` минут.

**Динамический стоп-лосс:**

Для каждой позиции:

* `initial_sl_price`, `current_sl_price`;
* `trailing_mode: "ema_atr" | "percent" | "none"`;
* `trailing_params` (например, `trail_atr_mult`, `trail_atr_mult2`).

Правила:

* для long `current_sl_price` может только повышаться;
* для short — только снижаться;
* обновление на каждом закрытии бара триггерного TF и/или при обновлении экстремума.

Дефолты:

* тренд-стратегии: `trailing_mode = "ema_atr"`;

  * `trail_atr_mult = 2.0`;
  * `trail_atr_mult2 = 1.0`;
* mean-reversion: `trailing_mode = "none"` или мягкий режим (через конфиг).

---

## 5. Нефункциональные требования

* Время одного цикла (без сетевых задержек) ≤ 500 ms при `update_interval_sec = 15`.
* Все ошибки API Bybit/Telegram логируются, критические — с уведомлением.
* Предусмотреть повтор запросов с backoff при временных ошибках.

---

## 6. Технологические требования

* Python: **≥ 3.11** (актуальная версия для macOS).
* ОС: macOS (локальный запуск).
* Возможность последующей упаковки в Docker/деплоя на Heroku.

Библиотеки (примерный набор, на усмотрение реализации):

* HTTP/WebSocket клиент для Bybit;
* Telegram-бот библиотека (тип `python-telegram-bot` или аналог);
* библиотеки для работы с временем/таймзонами;
* библиотека логирования (стандартный `logging` + ротация файлов);
* библиотека тестирования (`pytest`).

---

## 7. Работа с данными и файлами

### 7.1. Логи и отчёты

Структура:

* `logs/bot_YYYYMMDD.jsonl` — JSON-линии, события:

  * timestamp, type, payload (детали).
* `reports/trades_YYYYMMDD.csv` — журнал сделок:

  * datetime_open, datetime_close, symbol, side, size, entry_price, exit_price, SL, TP, fees, slippage_cost, pnl_gross, pnl_net, strategy_id, duration_sec.
* `reports/session_stats_YYYYMMDD.json`:

  * PnL за день/сессию;
  * winrate;
  * PnL по стратегиям и символам;
  * max_drawdown;
  * Leakage%, средний slippage_bps и т.п.

---

## 8. Интерфейсы и интеграции

### 8.1. Bybit API

* Используются официальные HTTP/WebSocket эндпоинты для:

  * свечей (kline);
  * стакана;
  * сделок (trade feed);
  * open interest;
  * постановки/отмены ордеров;
  * статуса ордеров и позиций.

Эндпоинты зависят от `bybit.mode` (live/demo).

### 8.2. Telegram Bot API

Конфиг секретов:

```yaml
telegram:
  bot_token: "YOUR_TELEGRAM_BOT_TOKEN"
  chat_id: 123456789
```

Поддерживаемые команды:

* `/start_bot`;
* `/stop_bot`;
* `/status`;
* `/set_risk <float_value>`.

Сообщения:

* открытия/закрытия позиций;
* периодические отчёты;
* итоговые отчёты.

---

## 9. Безопасность и конфигурация

### 9.1. Разделение конфигов

Два типа конфигов:

1. **Конфиг секретов** (например, `secrets.yaml`):

   * API-ключи Bybit (live и demo);
   * Telegram `bot_token` и `chat_id`;
   * другие секреты при необходимости.
   * не хранится в git (в `.gitignore`).

2. **Торговый конфиг** (например, `config.yaml` / `trading_config.yaml`):

   * `bybit.mode` (`"live"` / `"demo"`);
   * список символов (core/plus/rotation);
   * параметры риска;
   * параметры профилей и фильтров;
   * параметры стратегий;
   * параметры ротации;
   * параметры логирования/статистики;
   * включение/выключение стратегий.

При старте бот загружает оба файла, объединяет в рабочий runtime-конфиг.

### 9.2. Работа с секретами

* Секреты не пишутся в логи и не появляются в сообщениях Telegram.
* Переключение live/demo — только через конфиг и перезапуск.

---

## 10. Тестирование и приёмка

### 10.1. Unit-тесты (минимум)

* модуль риска:

  * корректный расчёт размера позиции и PnL;
  * соблюдение `per_trade_risk_pct`, `max_daily_loss_pct`, `max_concurrent_positions`, cooldown;
* пред-трейд фильтры:

  * корректная блокировка при нарушении глубины/спреда/latency/rel_volume/slippage;
* селектор TF-профиля:

  * корректный выбор AGGR/BAL/CONS при тестовых значениях;
  * работа гистерезиса и cooldown;
* стратегии:

  * на зафиксированных тестовых `MarketState` стратегии возвращают ожидаемые сигналы;
* mock-интеграция с Bybit:

  * создание/обновление/закрытие ордеров, обработка ошибок.

### 10.2. Сценарии приёмки

Проверяется, что:

* не допускается превышение `max_daily_loss_pct`;
* одновременно не более `max_concurrent_positions` открытых позиций;
* после убыточной сделки соблюдается cooldown;
* `/start_bot`, `/stop_bot`, `/status`, `/set_risk` работают строго согласно описанию;
* при некорректных ключах Bybit/Telegram бот не начинает торговлю и выдаёт понятное сообщение.

---

## 11. Этапы и приоритеты

### 11.1. MVP

Входит:

* интеграция с Bybit (demo/live);
* MarketState, режимы, TF-профили;
* пред-трейд фильтры;
* стратегии A–E;
* риск-менеджмент, dynamic SL;
* исполнение ордеров;
* базовая интеграция с Telegram;
* логи и отчёты;
* базовый набор unit-тестов.

### 11.2. Этап 2 (после MVP)

Возможные направления:

* встроенный бэктест (исторические данные);
* дополнительные метрики и отчёты;
* расширение стратегий;
* веб-интерфейс/дашборд (по желанию).

---

Если нужно, далее можно отдельно оформить таблицу параметров конфигов и схемы структур (`MarketState`, `Signal`, `PositionState`) в формате, удобном для ИИ-разработчика.
